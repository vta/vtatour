<dom-module id="import-data">
  <template>
    <style is="custom-style" include="shared-styles"></style>
    <style>
      .item-wrapper,
      .header {
        border-bottom: 1px solid #ccc;
      }
      hr {

        border-color: var(--primary-color);
      }

      .item-wrapper:hover {
        background-color: var(--vta-light-gray);
      }

      .item-wrapper.active:hover {
        background-color: var(--vta-white);
      }

      .item {
        padding: 12px 5% 0;
        @apply(--layout-horizontal);
        font-size: 1.05em;
        color: var(--secondary-text-color);
      }

      .item-wrapper.active .item {
        color: var(--primary-color);
      }

      .header {
        padding: 20px 5% 18px;
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.4em;
      }

      .route-code,.stop-code {
        min-width: 10%;
        padding: 0 20px;
        font-weight: bold;
      }

      .item-wrapper.active .route-name,.item-wrapper.active .stop-name {
        margin-bottom: 20px;
      }

      .route-details,.stop-details {
        @apply(--layout-flex);
      }

      .route-operations,.stop-operations {
        padding: 0 20px;
        margin-top: -12px;
      }

      paper-fab {
        position: absolute;
        right: 8%;
        top: -28px;
      }

      paper-button {
        top: 2px;
        padding: 0;
        background-color: transparent;
        color: var(--secondary-text-color);
      }

      paper-button iron-icon {
        --iron-icon-height: 40px;
        --iron-icon-width: 40px;
      }

      .route-departure-destination, .stop-departure-destination,.stop-list-listing {
        margin-bottom: 20px;
        display: none;
        color: var(--secondary-text-color);
      }

      .item-wrapper.active .route-departure-destination, .item-wrapper.active .stop-departure-destination, .item-wrapper.active .stop-list-listing {
        @apply(--layout-horizontal);
      }

      .route-departure,
      .route-destination,.stop-lat,
      .stop-lng {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
      }

      .route-detail-header,.stop-lat-header {
        font-weight: bold;
        margin-right: 30px;
      }

      .edit-route-operation,.stop-route-operation {
        display: none;
        padding: 21px 5%;
        font-size: 1.4em;
        text-transform: capitalize;
        text-align: right;
      }

      .item-wrapper.active paper-button iron-icon.expand,
      .item-wrapper paper-button iron-icon.collapse,
      .route-map-template,
      .stop-map-template,
      .item-wrapper route-map {
        display: none;
      }

      .item-wrapper paper-button iron-icon.expand,
      .item-wrapper.active paper-button iron-icon.collapse,
      .item-wrapper.active route-map,
      .item-wrapper.active .edit-route-operation {
        display: block;
      }
      #byte_content {
        margin: 5px 0;
        max-height: 100px;
        overflow-y: auto;
        overflow-x: hidden;
      }
      #byte_range { margin-top: 5px; }
      .loadButtons{
            width: 12%;
            background: gainsboro;
      }
      .add-stop-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        float: left;
      }

      .add-stop-wrapper paper-button {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 0.2em .6em;
        width: 167px;

      }
      .clear-break{
        clear:both;
      }

      paper-toolbar {
        --paper-toolbar-background: var(--paper-blue-900);
      }
      paper-button.primary {
        color: var(--primary-color);
        font-size: 22px;
      }
      .column1 {
        width: 50%;
        padding: 0 20px 0 0;
        margin-right: 16%;
      }

      .column-container {
        width: 35%;
      }
      .stop-list-listing{
        margin-left: 0px;
        padding-left: 0px;
        width: 100%;
      }
      .download-icon{
        height: 20px;
      }

      #saveOperationResultModal {
        width: auto;
        background-color: transparent;
        color: var(--vta-white);
        box-shadow: none;
      }

      #saveOperationResultModal .icon {
        text-align: center;
      }

      #saveOperationResultModal iron-icon {
        width: 140px;
        height: 140px;
        padding: 20px;
        text-align: center;
        -webkit-border-radius: 50%;
        border-radius: 50%;
      }

      #saveOperationResultModal .message-wrapper.success iron-icon {
        background-color: var(--primary-color);
      }

      #saveOperationResultModal .message-wrapper.error iron-icon {
        background-color: var(--secondary-color);
      }

      #saveOperationResultModal .message {
        text-align: center;
        font-size: 2.5em;
        line-height: 1;
        text-transform: uppercase;
        font-weight: bold;
        margin-top: 10px;
      }
    </style>

    <firebase-document
      app-name="vta"
      id="routeInfo"
      data="{{_routeInfoOrigin}}">
    </firebase-document>
    <firebase-document
      app-name="vta"
      id="routeDetails"
      data="{{_routeDetailsOrigin}}">
    </firebase-document>
    <div class="inner-content">
      <h2 class="page-title">Import Data</h2>

      <div>
        &nbsp; Step 1: Select Stop List File:  <input type="file" id="stop_list" name="stop_list" />
        <br/>

        <div class="add-stop-wrapper">
        <paper-button on-click="_loadStopeData" >
          <iron-icon icon="file-download" class="download-icon"></iron-icon>Load Stops
        </paper-button>
       </div>
      </div>
      <br/><br/>
      <div class="clear-break">
        &nbsp; Step 2: Select Route List File:  <input type="file" id="route_list" name="route_list" />
        <br/>
        <div class="add-stop-wrapper">
        <paper-button on-click="_loadRoutesData" >
          <iron-icon icon="file-download" class="download-icon"></iron-icon>Load Routes
        </paper-button>
       </div>
      </div>

      <br/><br/>
      <div class="clear-break">
        <paper-button  on-click="_batchImportRoutesListData" class="primary">Batch Import</paper-button>
      </div>
      <paper-material elevation="1">
        <paper-tabs scrollable selected="{{selectedTab}}" fit-container>
          <paper-tab>Stops</paper-tab>
          <paper-tab>Routes</paper-tab>
        </paper-tabs>
        <template is="dom-if" if="[[_stopTabIsSelected(selectedTab)]]">
          <div class="item header">
            <div class="route-code">Code</div>
            <div class="route-details">Stop name</div>
            <div class="route-operations">

            </div>
          </div>
          <template is="dom-repeat" items="[[_imported_stops]]" as="stop" >
            <div class="item-wrapper" data-stop-index$="[[index]]" data-stop-code$="[[stop.id]]">
              <div class="item stop">
                <div class="stop-code">[[stop.id]]</div>
                <div class="stop-details">
                  <div class="stop-name">[[stop.name]]</div>
                  <div class="stop-departure-destination">
                    <div class="stop-lat">
                      <div class="stop-lat-header">Latitude</div>
                      <div class="stop-lat-value">[[stop.lat]]</div>
                    </div>
                    <div class="stop-lng">
                      <div class="stop-lng-header">Longitidue</div>
                      <div class="stop-lng-value"> &nbsp;[[stop.lng]]</div>
                    </div>
                  </div>
                </div>
                <div class="stop-operations">
                  <paper-button on-click="_toggleStop" data-stop-index$="[[index]]">
                    <iron-icon class="expand" icon="icons:expand-more"></iron-icon>
                    <iron-icon class="collapse" icon="icons:expand-less"></iron-icon>
                  </paper-button>
                </div>
              </div>
              <div class="stop-map"></div>
            </div>
          </template>
        </template>
        <template is="dom-if" if="[[_routesTabIsSelected(selectedTab)]]">
          <div class="item header">
            <div class="route-code">Code</div>
            <div class="route-details">Route name</div>
            <div class="route-operations">

            </div>
          </div>
          <template is="dom-repeat" items="[[_imported_routes]]" as="route">
            <div class="item-wrapper" data-route-index$="[[index]]" data-route-code$="[[route.code]]">
              <div class="item route">
                <div class="route-code">[[route.code]]</div>
                <div class="route-details">
                  <div class="route-name">[[route.name]]</div>
                  <div class="route-departure-destination">
                    <div class="route-departure">
                      <div class="route-detail-header">Departure</div>
                      <div class="route-detail-value">[[route.departure]]</div>
                    </div>
                    <div class="route-destination">
                      <div class="route-detail-header">Destination</div>
                      <div class="route-detail-value">[[route.destination]]</div>
                    </div>
                  </div>
                  <div class="container item stop-list-listing">
                    <div class="column1">
                        <div class="stops-wrapper">
                          <h3>Direction A - Stops</h3>
                          <div class="stop-list">
                            <div role="listbox">
                              <template is="dom-repeat" items="{{route.routeDetails.a.stops}}" as="stop">
                                <paper-item>
                                  <paper-item-body>[[stop.name]]</paper-item-body>
                                </paper-item>
                              </template>
                            </div>
                          </div>
                        </div>
                    </div>
                    <div class="column1">
                        <div class="stops-wrapper">
                          <h3>Direction B - Stops</h3>
                          <div class="stop-list">
                            <div role="listbox">
                              <template is="dom-repeat" items="{{route.routeDetails.b.stops}}" as="stop">
                                <paper-item>
                                  <paper-item-body>[[stop.name]]</paper-item-body>
                                </paper-item>
                              </template>
                            </div>
                          </div>
                        </div>
                    </div>
                  </div>
                </div>
                <div class="route-operations">
                  <paper-button on-click="_toggleRoute" data-route-index$="[[index]]">
                    <iron-icon class="expand" icon="icons:expand-more"></iron-icon>
                    <iron-icon class="collapse" icon="icons:expand-less"></iron-icon>
                  </paper-button>
                </div>
              </div>
              <div class="route-map"></div>
            </div>
          </template>

          <div class="route-map-template">
            <route-map id="routeMap" geo-points="{{_videoGeoPointsOrigin}}"></route-map>
          </div>
        </template>
      </paper-material>
    </div>
    <paper-dialog id="saveOperationResultModal" modal>
      <template is="dom-if" if="{{_operationSuccess}}">
        <div class="message-wrapper success">
          <div class="icon">
            <iron-icon icon="icons:check"></iron-icon>
          </div>
          <div class="message">Done</div>
          <div class="">{{_operationMessageDetail}}</div>
        </div>
      </template>
      <template is="dom-if" if="{{!_operationSuccess}}">
        <div class="message-wrapper success">
          <div class="icon">
            <iron-icon icon="icons:cached"></iron-icon>
          </div>
          <div class="message">Processing...</div>
          <div class="">{{_operationMessageDetail}}</div>
        </div>
      </template>
    </paper-dialog>
    <maps-utils id="mapsUtils"></maps-utils>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'import-data',

      properties: {
        _imported_routes: {
          type: Array,
          value: []
        },
        _imported_stops: {
          type: Array,
          value: []
        },
        _activeStopCode: {
          type: String,
          value: ''
        },
        _routes: {
          type: Array
        },
        _activeRouteCode: {
          type: String,
          value: ''
        },
        selectedTab: {
          type: Number,
          value: 0
        },
        _videoGeoPointsOrigin:{
          type: Object,
          value: {}
        },
        _routeInfoOrigin: {
          type: Object,
          //observer: '_routeInfoOriginChange'
        },
        _routeInfo: {
          type: Object,
          value: {}
        },
        _routeDetailsOrigin: {
          type: Object,
          //observer: '_routeDetailsOriginChange'
        },
        _routeDetails: {
          type: Object,
          value: {
            a: {
              stops: [],
              videoGeoPoints: {},
              videoId: null,
              videoUrl: null
            },
            b: {
              stops: [],
              videoGeoPoints: {},
              videoId: null,
              videoUrl: null
            }
          }
        },
      },
      _showOperationResultModal: function(isSuccess, operationDetailMessage) {
        this.$.saveOperationResultModal.open();
        var self = this;
        this._operationSuccess = isSuccess;
        this._operationMessageDetail = operationDetailMessage;
      },
      _closeOperationResultModal: function() {
        this.$.saveOperationResultModal.close();
      },
      _stopTabIsSelected: function(selectedTB) {
         return selectedTB === 0;
       },
       _routesTabIsSelected: function(selectedTB) {
          return selectedTB === 1;
        },
      _setStops : function(stopListArray){
        this._imported_stops = stopListArray;
        this.selectedTab = 0;
        this.$.saveOperationResultModal.close();
        this._showOperationResultModal(true,"Stop list data loaded, after all stops data loaded you can load route list data");
        var self = this;
        setTimeout(function(){
           self.$.saveOperationResultModal.close();
        }, 1000);
      },
      _setRoutes : function(routeListArray){
        this._imported_routes = routeListArray;
        this.selectedTab = 1;
        this.$.saveOperationResultModal.close();
        this._showOperationResultModal(true,"Route list data loaded, please verify route list data after that you can click on Batch Import to update database ");
        var self = this;
        setTimeout(function(){
           self.$.saveOperationResultModal.close();
        }, 2000);
      },
      _readStops:function(opt_startByte,opt_stopByte){
        var files = document.getElementById('stop_list').files;
         if (!files.length) {
           this.$.saveOperationResultModal.close();
           alert('Please select a file!');
           return;
         }

         var file = files[0];
         var start = 0;
         var stop = file.size - 1;
         var reader = new FileReader();
         var thisPolyMerObject = this;
         // If we use onloadend, we need to check the readyState.
         reader.onloadend = function(evt) {
           if (evt.target.readyState == FileReader.DONE) { // DONE == 2
             //document.getElementById('byte_content').textContent = evt.target.result;
             //this._imported_routes = JSON.parse(evt.target.result);
             var rawStopsData = JSON.parse(evt.target.result);
             console.log(this.rawStopsData);
             let stopListArray = [];

             for(var i=0;i<rawStopsData.length;i++){
                 var rawStopObject = rawStopsData[i];
                 var stopObject = {
                   backofficeName:rawStopObject.stop_id+' - '+rawStopObject.stop_name,
                   lat:rawStopObject.stop_lat,
                   lng:rawStopObject.stop_lon,
                   name:rawStopObject.stop_name,
                   type:rawStopObject.stop_type,
                   id:rawStopObject.stop_id,
                   code:rawStopObject.stop_code,
                 }
                 if(stopObject.id){
                    stopListArray.push(stopObject);
                 }
             }

             thisPolyMerObject._setStops(stopListArray);
             if(stopListArray.length==0){
               alert('please select valid stop list json file');
             }
           }
         };

         var blob = file.slice(start, stop + 1);
         reader.readAsBinaryString(blob);
      },
      _readRoutes:function(opt_startByte,opt_stopByte){
        if(!this._imported_stops.length){
          this.$.saveOperationResultModal.close();
          alert('Please load a stop list first!');
          return;
        }
        var files = document.getElementById('route_list').files;
         if (!files.length) {
           this.$.saveOperationResultModal.close();
           alert('Please select a file!');
           return;
         }

         var file = files[0];
         var start = 0;
         var stop = file.size - 1;
         var reader = new FileReader();
         var thisPolyMerObject = this;
         // If we use onloadend, we need to check the readyState.
         reader.onloadend = function(evt) {
           if (evt.target.readyState == FileReader.DONE) { // DONE == 2
             //document.getElementById('byte_content').textContent = evt.target.result;
             //this._imported_routes = JSON.parse(evt.target.result);
             var rawRoutesData = JSON.parse(evt.target.result);
             console.log(rawRoutesData);

             let routeListArray = [];

             var getStopObject = function(stopId){
                var processedStopObject = null;
                for(var stopCount = 0;stopCount<thisPolyMerObject._imported_stops.length;stopCount++){
                    if(stopId==thisPolyMerObject._imported_stops[stopCount].id){
                      processedStopObject = thisPolyMerObject._imported_stops[stopCount];
                    }
                }
                if(processedStopObject){
                  return processedStopObject;
                }
                return false;
             }

             var objectifyLatLon =  function(arr) {
                  var rv = {};
                  for (var i = 0; i < arr.length; ++i){
                    var newLatLongObject = {
                      lat:parseFloat(arr[i].lat),
                      lng:parseFloat(arr[i].lon)
                    }
                    if (!isNaN(newLatLongObject.lat) && !isNaN(newLatLongObject.lng)) {
                      rv[i+1] = newLatLongObject;
                    }

                  }
                  return JSON.parse(JSON.stringify(rv));
                }

                var toTitleCase =  function(str){
                    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
                }

             for(var i=0;i<rawRoutesData.length;i++){
               var rawRouteObject = rawRoutesData[i];
               var rawRouteObjectOtherDirection = null;
               if(rawRoutesData[i+1] && rawRoutesData[i+1].route_id==rawRouteObject.route_id && rawRoutesData[i+1].direction_id==1){
                 rawRouteObjectOtherDirection = rawRoutesData[i+1];
               }
               if(rawRouteObject.direction_id==0){
                 var departure,destination;
                 var sourcedestinationArray = rawRouteObject.route_long_name.split('-');
                 if(sourcedestinationArray.length>1){
                   departure = sourcedestinationArray[0].trim();
                   destination = sourcedestinationArray[1].trim();
                 }else{
                   departure = rawRouteObject.route_long_name.trim();
                   destination = '';
                 }

                 var routeObject = {
                   code:rawRouteObject.route_id,
                   name:rawRouteObject.route_id+' - '+toTitleCase(rawRouteObject.route_long_name).replace('-',' to '),
                   departure:toTitleCase(departure),
                   destination:toTitleCase(destination),
                   directionAName:'west',
                   directionBName:'east',
                   routeDetails: {
                       a: {
                         stops: [],
                         videoGeoPoints: {},
                         videoId: null,
                         videoUrl: null
                       },
                       b: {
                         stops: [],
                         videoGeoPoints: {},
                         videoId: null,
                         videoUrl: null
                       }
                   }
                 }

                 var routesStopsArray = [];
                 if(rawRouteObject.lst_stop_ids){
                   var parsed1StStopIds = rawRouteObject.lst_stop_ids.split(',')
                   if(parsed1StStopIds.length){
                      for(var paredStopIdCount = 0;paredStopIdCount<parsed1StStopIds.length;paredStopIdCount++){
                        var pasedProcesedStopObject = getStopObject(parsed1StStopIds[paredStopIdCount]);
                        if(pasedProcesedStopObject){
                          routesStopsArray.push({
                            lat:parseFloat(pasedProcesedStopObject.lat),
                            lng:parseFloat(pasedProcesedStopObject.lng),
                            name:pasedProcesedStopObject.name,
                            code:pasedProcesedStopObject.id,
                          })
                        }
                      }
                   }
                 }
                 var routesStopsOtherDirectionArray = [];
                 if(rawRouteObjectOtherDirection && rawRouteObjectOtherDirection.lst_stop_ids){
                   var parsed1StStopIds = rawRouteObjectOtherDirection.lst_stop_ids.split(',')
                   if(parsed1StStopIds.length){
                      for(var paredStopIdCount = 0;paredStopIdCount<parsed1StStopIds.length;paredStopIdCount++){
                        var pasedProcesedStopObject = getStopObject(parsed1StStopIds[paredStopIdCount]);
                        if(pasedProcesedStopObject){
                          routesStopsOtherDirectionArray.push({
                            lat:parseFloat(pasedProcesedStopObject.lat),
                            lng:parseFloat(pasedProcesedStopObject.lng),
                            name:pasedProcesedStopObject.name,
                            code:pasedProcesedStopObject.id,
                          })
                        }
                      }
                   }
                 }

                 routeObject.routeDetails.a.stops = routesStopsArray;
                 routeObject.routeDetails.b.stops = routesStopsOtherDirectionArray;

                 if(rawRouteObject.routeshape){
                   var geoPointsArrayString = "["+rawRouteObject.routeshape+"]";
                   var geoPointsArray = eval(geoPointsArrayString);
                   routeObject.routeDetails.a.videoGeoPoints = objectifyLatLon(geoPointsArray);
                 }
                 if(rawRouteObjectOtherDirection && rawRouteObjectOtherDirection.routeshape){
                   var geoPointsArrayString = "["+rawRouteObjectOtherDirection.routeshape+"]";
                   var geoPointsArray = eval(geoPointsArrayString);
                   routeObject.routeDetails.b.videoGeoPoints = objectifyLatLon(geoPointsArray);
                 }

                 if(routeObject.code){
                    routeListArray.push(routeObject);
                 }
               }
             }
             console.log('check final routes array');
             console.log(routeListArray);

             thisPolyMerObject._setRoutes(routeListArray);
             if(routeListArray.length==0){
               alert('please select valid stop list json file');
             }
           }
         };

         var blob = file.slice(start, stop + 1);
         reader.readAsBinaryString(blob);
      },

      _loadStopeData: function(e) {
        this.$.saveOperationResultModal.close();
        this._showOperationResultModal(false,"Stop list data getting loaded please wait ");
        this._readStops();
      },
      _loadRoutesData: function(e) {
        this.$.saveOperationResultModal.close();
        this._showOperationResultModal(false,"Route list data getting loaded please wait ");
              this._readRoutes();
      },
      _toggleRoute: function(e) {
        var oldActiveRoute = Polymer.dom(this.root).querySelector('.item-wrapper.active');
        var paperButton;
        var routeIndex;
        var activeRoute;

        if (e.srcElement.localName === 'iron-icon') {
          paperButton = e.srcElement.parentNode;
        } else {
          paperButton = e.srcElement;
        }

        // Get the info of the selected route
        routeIndex = paperButton.getAttribute('data-route-index');
        activeRoute = Polymer.dom(this.root).querySelector('.item-wrapper[data-route-index="' + routeIndex + '"]');

        // Remove the active class
        if (oldActiveRoute) {
          oldActiveRoute.classList.remove('active');
        }

        // Check if the same route was collapsed
        if (oldActiveRoute !== activeRoute) {
          var routeMap = Polymer.dom(this.root).querySelector('#routeMap');

          activeRoute.classList.add('active');

          // Append the map element
          Polymer.dom(activeRoute.querySelector('.route-map')).appendChild(routeMap);
          this._activeRouteCode = activeRoute.getAttribute('data-route-code');
          this._videoGeoPointsOrigin = this._imported_routes[routeIndex].routeDetails.a.videoGeoPoints;

        }
      },
      _toggleStop: function(e) {
        var oldActiveStop = Polymer.dom(this.root).querySelector('.item-wrapper.active');
        var paperButton;
        var stopIndex;
        var activeStop;

        if (e.srcElement.localName === 'iron-icon') {
          paperButton = e.srcElement.parentNode;
        } else {
          paperButton = e.srcElement;
        }

        // Get the info of the selected route
        stopIndex = paperButton.getAttribute('data-stop-index');
        activeStop = Polymer.dom(this.root).querySelector('.item-wrapper[data-stop-index="' + stopIndex + '"]');

        // Remove the active class
        if (oldActiveStop) {
          oldActiveStop.classList.remove('active');
        }

        // Check if the same route was collapsed
        if (oldActiveStop !== activeStop) {
          activeStop.classList.add('active');
          this._activeStopCode = activeStop.getAttribute('data-stop-code');
        }
      },
      _saveRoute: function(fullRouteData,callback) {
        var self = this;
        if(!fullRouteData){
            return callback({message:'data missing'},false);
        }
        if(!fullRouteData.code){
            return callback({message:'data missing - before trim'},false);
        }
        var code = fullRouteData.code.trim();
        if(!code){
            return callback({message:'Code missing - after trim'},false)
        }
        var routeInfo = fullRouteData;
        var routeDetails = routeInfo.routeDetails;
        delete routeInfo.routeDetails;
        var update = {};

        update['routes/'+code] = routeInfo;
        update['route-details/'+code] = routeDetails;
        console.log('check below update deep path');
        console.log(update)
        //return callback(null,true);
        //firebase.database().ref().update(update);
        var firebaseDb = this.$.routeInfo.db;
        var firebaseDbRef = firebaseDb.ref();
        firebaseDbRef.update(update, function(error) {
          if (error) {
            console.log("Error updating data:", error);
          }else{
            console.log('Write Success');
          }
          return callback(null,true);
        });
        // self._routeInfoOrigin = routeInfo;
        // self._routeDetailsOrigin = routeDetails;
        // console.log(self.$.routeInfo);
        // console.log(self.$.routeDetails);
        // setTimeout(function(){
        //   console.log('code: '+code);
        //   console.log('final route info');
        //   console.log(self._routeInfoOrigin);
        //   console.log('final route details');
        //   console.log(self._routeDetailsOrigin);
        //   self.$.routeInfo.save('/routes', code)
        //     .then(function() {
        //       return self.$.routeDetails.save('/route-details', code);
        //     }).then(function() {
        //       console.log('Route data + route details saving success');
        //       console.log('Next item will start after 500ms');
        //          return callback(null,true);
        //     }).catch(function(error) {
        //       console.log('must check below error if any');
        //       console.log(error);
        //       //return callback(error,null)
        //     });
        // }, 1000);
      },
      _batchImportRoutesListData:function(e) {

        if(!confirm('Are you sure? This action will update new routes in database, but will not overwrite existing routes.')){
          return false;
        }


        var self = this;

        if(!this._imported_stops.length){
          this.$.saveOperationResultModal.close();
          alert('Please load a stop list first!');
          return;
        }
        if(!this._imported_routes.length){
          this.$.saveOperationResultModal.close();
          alert('Please load a route list!');
          return;
        }
        this._showOperationResultModal(false,"Route list data getting updated in firebase db, it will take a while, please wait...");

        var updateAble = 0;
        var self = this;
        var startUpdate =  function(index){
          if(index<self._imported_routes.length){
            var fullRouteDetails = {};
            fullRouteDetails = self._imported_routes[index];
            var alreadyHadRouteInfoData = false;
            var alreadyHadRouteDetailsData = false;
            var code = fullRouteDetails.code.trim();
            self.$.routeInfo.getStoredValue('/routes/' + code)
              .then(function(data) {
                // console.log('check route root data');
                // console.log(data);
                if(data && data.code){
                  alreadyHadRouteInfoData = true;
                }
                return self.$.routeDetails.getStoredValue('/route-details/' + code);
              }).then(function(data) {
                // console.log('check route detailed data');
                // console.log(data);
                if(data && data.a && data.a.stops.length && data.a.stops[0] && data.a.stops[0].sec && data.a.stops[0].sec !=null  ){
                  alreadyHadRouteDetailsData = true;
                }
                if(alreadyHadRouteInfoData && alreadyHadRouteDetailsData){
                  startUpdate(index+1);
                }else{
                  //alert('safe to proceed to final store');
                  self._saveRoute(fullRouteDetails,function(err,success){
                      if(err){
                        console.log('There is a error to check')
                        console.log(err);
                      }
                      console.log('Success: '+success);
                      startUpdate(index+1);
                  })
                }

              }).catch(function(error) {
                console.log(error);
              });
          }else{
            self._showOperationResultModal(true,"All new routes updated in firebase db");
            setTimeout(function(){
               self.$.saveOperationResultModal.close();
            }, 2000);
            return;
          }
        }
        startUpdate(0);
      },
    });
  })();
  </script>
</dom-module>
