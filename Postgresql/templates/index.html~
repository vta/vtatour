`<!DOCTYPE html>
<html> 
<head> 
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
	<title>Video 70 </title> 

	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyC2zG8n0SSvjlED4driQO4cSToszU0WIc0&libraries=places,geometry" type="text/javascript"></script> 
    <script src="{{ url_for('static', filename = 'geoaddress.js') }}"></script>
        <script src="{{ url_for('static', filename = 'three.min.js') }}"></script>
        <script src="{{ url_for('static', filename = 'GSVPano.js') }}"></script>

	
	 <!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> 
     <script src="{{ url_for('static', filename = 'Hyperlapse.js') }}"></script>
    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>


 
	<script> 
		   var config = {
           apiKey: "AIzaSyCDtI3bfIhVlYdG9zrYzKtqCOqQWldRI7c",
           authDomain: "vtavirtualtransit-7c904.firebaseapp.com",
           databaseURL: "https://vtavirtualtransit-7c904.firebaseio.com",
           projectId: "vtavirtualtransit-7c904",
           storageBucket: "vtavirtualtransit-7c904.appspot.com",
           messagingSenderId: "141415834682"
         };
        
        firebase.initializeApp(config)

      
        
        $('#spinner').hide();
		var jsonarray = new Array();
		var coords = [];
		var start_point;
		var end_point ;
		var lookat_point = new google.maps.LatLng(44.34232747290594, 6.786460550292986); //not in use
		var map, directions_renderer, directions_service, streetview_service, geocoder;
		var start_pin, end_pin, pivot_pin, camera_pin;
		var _elevation = 0;
		var _route_markers = [];
		var stops=[];
		var snapts=[];
		var stcordinates=[];
		var encordinates=[];
		var i =0;
		var getb=0;
		var routedirid =[];
		
		function firerequest(routename,dir) {
			if(stops.length>0){
				stops=[];
			}
			console.log(routename)
			console.log(dir)
			console.log('route-details/'+routename+'/'+dir+'/stops/')
			firebase.database().ref('route-details/'+routename+'/'+dir+'/stops/').once('value').then(function(snapshot) {
			           snapshot.forEach(function(userSnapshot) {
			               var username = userSnapshot.val();
			               this.stops.push(username);
			              
			           });
			       });
		}
		function getrouteinfo() {
			
		
			var e = document.getElementById("ddldir");
			this.dir = e.options[e.selectedIndex].value;
			this.routename = document.getElementById("routeid").value;
			var e = document.getElementById("ddlangle");
			this.camangle = e.options[e.selectedIndex].value;
			
			firedbdata();
		}

		function firedbdata() {

			if (dir=='a')
			{
				firerequest(routename,dir);
				setTimeout(getcords,5000);
			}
			if (dir=='b') {
				firerequest(routename,dir);
				setTimeout(getcords,5000);
			}
			if (dir=='all') { //---------go to line 161
				this.dir='a';
				this.getb=1;
				firerequest(routename,dir);
				setTimeout(getcords,5000);
			}
			if (getb==2) { //Check line 161 -------------------
				this.dir='b';
				this.getb=0;
				firerequest(routename,dir);
				setTimeout(getcords,5000);
			}

		}


		function postdata() {

			console.log(snapts)
			routedirid[0]="rid";
			routedirid[1]=routename;
			routedirid[2]=dir;
			routedirid[3]=camangle;

			
            var stationJson = JSON.stringify(routedirid);
            var pythonUrl = "http://vta_app.com/json"; //python url to post data 
            var sendCordinates = $.ajax({
                  type: 'POST',
                  url: pythonUrl,
                  dataType: "json",
                  data: stationJson,
                  contentType: 'application/json',
                  success: function(resultData) {  
                  console.log("done"); }
            });

			var cordinatesJson = JSON.stringify(snapts);
            $('#spinner').show();
			var pythonUrl = "http://vta_app.com/json"; //python url to post data 
			var sendCordinates = $.ajax({
			      type: 'POST',
			      url: pythonUrl,
			      dataType: "json",
			      data: cordinatesJson,
			      contentType: 'application/json',
			      success: function(resultData) { 
                        if(resultData=='100')
                        $('#spinner').text("Video Created");
                     	if(resultData=='101')
                        $('#spinner').text("Error Creating Video");
                    	
                    	if(getb==1)// will call the function again to download images in b direction-------------------------------------
                    	{
                    	this.getb=2;
                    	firedbdata();
                    	}
                
			      }
                  ,
                  complete: function(){
                       // $('#spinner').hide();
                  		}
					});
		}
		
		function getcords() {


			if(stops.length>0) {
				console.log(stops.length)
				console.log(coords.length)
				if(i!=stops.length-1){
				console.log("worked!");
				this.stcordinates[0]=stops[i]['lat'];
				this.stcordinates[1]=stops[i]['lng'];
				this.encordinates[0]=stops[i+1]['lat'];
				this.encordinates[1]=stops[i+1]['lng'];
				init();
				this.i=i+1;
			}
			else {
				this.snapts=[];
				i=0;

				
            while(i<(coords.length-coords.length%20))
            { 

             console.log(coords[i]+" "+i)
             $.getJSON('https://roads.googleapis.com/v1/snapToRoads?path='+coords[i]+'|'+coords[i+2]+'|'+coords[i+3]+'|'+coords[i+4]+'|'+coords[i+5]+'|'+coords[i+6]+'|'+coords[i+7]+'|'+coords[i+8]+'|'+coords[i+9]+'|'+coords[i+10]+'|'+coords[i+11]+'|'+coords[i+12]+'|'+coords[i+13]+'|'+coords[i+14]+'|'+coords[i+15]+'|'+coords[i+16]+'|'+coords[i+17]+'|'+coords[i+18]+'|'+coords[i+19]+'|'+coords[i+20]+'&key=AIzaSyCDtI3bfIhVlYdG9zrYzKtqCOqQWldRI7c', function(data) {
             		
             		for(i=0;i<data['snappedPoints'].length;i++){

 					/*console.log(data['snappedPoints'][i]['location']['latitude']+','+data['snappedPoints'][i]['location']['longitude']+' sanpped :'+i)
 					console.log(coords[i]+' original :'+i)
 					'|'+coords[i+1]+'|'+coords[i+2]+'|'+coords[i+3]+'|'+coords[i+4]+'|'+coords[i+5]+'|'+coords[i+6]+'|'+coords[i+7]+'|'+coords[i+8]+'|'+coords[i+9]+'|'+coords[i+10]+'|'+coords[i+11]+'|'+coords[i+12]+'|'+coords[i+13]+'|'+coords[i+14]+'|'+coords[i+15]+'|'+coords[i+16]+'|'+coords[i+17]+'|'+coords[i+18]+'|'+coords[i+19]+'|'+coords[i+20]+'|'+coords[i+21]+'|'+coords[i+22]+'|'+coords[i+23]+'|'+coords[i+24]+'|'+coords[i+25]+'|'+coords[i+26]+'|'+coords[i+27]+'|'+coords[i+28]+'|'+coords[i+29]+'|'+coords[i+30]+'|'+coords[i+31]+'|'+coords[i+32]+'|'+coords[i+33]+'|'+coords[i+34]+'|'+coords[i+35]+'|'+coords[i+36]+'|'+coords[i+37]+'|'+coords[i+38]+'|'+coords[i+39]+'|'+coords[i+40]+'|'+coords[i+41]+'|'+coords[i+42]+'|'+coords[i+43]+'|'+coords[i+44]+'|'+coords[i+45]+'|'+coords[i+46]+'|'+coords[i+47]+'|'+coords[i+48]+'|'+coords[i+49]+'&interpolate=false
 					*/temp=data['snappedPoints'][i]['location']['latitude']+','+data['snappedPoints'][i]['location']['longitude'];
 					snapts.push(temp)
 				
 					}

 					
			});  

			i=i+15;     
            }
 				setTimeout(postdata,5000);
            
			
				}
			}
		}


		function show(msg) {
			document.getElementById("text").innerHTML = msg;
		}

		function init() {
			
            $('#spinner').hide();
	        var a = new google.maps.LatLng(stcordinates[0], stcordinates[1]);
            var b = new google.maps.LatLng(encordinates[0], encordinates[1]);
            console.log(encordinates[0]);
            var dist = (google.maps.geometry.spherical.computeDistanceBetween(a,b));
      

			start_point = new google.maps.LatLng(stcordinates[0], stcordinates[1]); 
			end_point = new google.maps.LatLng(encordinates[0], encordinates[1]);   
			if( window.location.hash ) {
				parts = window.location.hash.substr( 1 ).split( ',' );
				start_point = new google.maps.LatLng(parts[0], parts[1]);
				lookat_point = new google.maps.LatLng(parts[2], parts[3]);
				end_point = new google.maps.LatLng(parts[4], parts[5]);
				_elevation = parts[6] || 0;
			} 

			/* Map */

			function snapToRoad(point, callback) {
				var request = { origin: point, destination: point, travelMode: google.maps.TravelMode["TRANSIT"] };
				directions_service.route(request, function(response, status) {
					if(status=="OK") callback(response.routes[0].overview_path[0]);
					else callback(null);
				});
			}

			function changeHash() {
				window.location.hash = start_pin.getPosition().lat() + ',' + start_pin.getPosition().lng() + ','
					+ pivot_pin.getPosition().lat() + ',' + pivot_pin.getPosition().lng() + ','
					+ end_pin.getPosition().lat() + ',' + end_pin.getPosition().lng() + ','
					+ _elevation;
			}

			var mapOpt = { 
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				center: start_point,
				zoom: 15
			};

			map = new google.maps.Map(document.getElementById("map"), mapOpt);
			geocoder = new google.maps.Geocoder();

			var overlay = new google.maps.StreetViewCoverageLayer();
			overlay.setMap(map);

			directions_service = new google.maps.DirectionsService();
			directions_renderer = new google.maps.DirectionsRenderer({draggable:false, markerOptions:{visible: false}});
			directions_renderer.setMap(map);
			directions_renderer.setOptions({preserveViewport:true});

			camera_pin = new google.maps.Marker({
				position: start_point,
				map: map
			});

			start_pin = new google.maps.Marker({
				position: start_point,
				draggable: false,
				map: map
			});

			google.maps.event.addListener (start_pin, 'dragend', function (event) {
				snapToRoad(start_pin.getPosition(), function(result) {
					start_pin.setPosition(result);
					start_point = result;
					changeHash();
				});
			});

			end_pin = new google.maps.Marker({
				position: end_point,
				draggable: false,
				map: map
			});

			google.maps.event.addListener (end_pin, 'dragend', function (event) {
				snapToRoad(end_pin.getPosition(), function(result) {
					end_pin.setPosition(result);
					end_point = result;
					changeHash();
				});
			});

			pivot_pin = new google.maps.Marker({
				position: lookat_point,
				draggable: false,
				map: map
			});

			google.maps.event.addListener (pivot_pin, 'dragend', function (event) {
				hyperlapse.setLookat( pivot_pin.getPosition() );
				changeHash();
			});

			function findAddress(address) {
				geocoder.geocode( { 'address': address}, function(results, status) {
					if (status == google.maps.GeocoderStatus.OK) {
						map.setCenter(results[0].geometry.location);
						o.drop_pins();
					} else {
						show( "Geocode was not successful for the following reason: " + status );
					}
				});
			}

		/*	var search = document.getElementById( 'searchButton' );
			search.addEventListener( 'click', function( event ) {
				event.preventDefault();
				findAddress( document.getElementById("address").value );
			}, false );*/


			/* Hyperlapse */

			var pano = document.getElementById('pano');
			var is_moving = false;
			var px, py;
			var onPointerDownPointerX=0, onPointerDownPointerY=0;

			var hyperlapse = new Hyperlapse(pano, {
				lookat: lookat_point,
				fov: 80,
				millis: 50,
				width: window.innerWidth,
				height: window.innerHeight,
				zoom: 1,
				use_lookat: false,
				distance_between_points: 2,
				max_points: dist,
				elevation: _elevation
			});
			
			

			hyperlapse.onError = function(e) {
				show( "Fetching Cordinates: "+ e.message );
			};

			hyperlapse.onRouteProgress = function(e) {
				_route_markers.push( new google.maps.Marker({
					position: e.point.location,
					draggable: false,
					icon: "http://vta_app.com/static/dot_marker.png",
					map: map
					})
				);
			};

			hyperlapse.onRouteComplete = function(e) {
				directions_renderer.setDirections(e.response);
				show( "Number of Points: "+ hyperlapse.length() );
			
			getcords();
				
			};

			hyperlapse.onLoadProgress = function(e) {
				show( "Loading: "+ (e.position+1) +" of "+ hyperlapse.length() );
			};

			hyperlapse.onLoadComplete = function(e) {
				show( "" +
					"Start: " + start_pin.getPosition().toString() + 
					"<br>End: " + end_pin.getPosition().toString() + 
					"<br>Lookat: " + pivot_pin.getPosition().toString() + 
					"<br>Ready." );
			};

			hyperlapse.onFrame = function(e) {
				show( "" +
					"Start: " + start_pin.getPosition().toString() + 
					"<br>End: " + end_pin.getPosition().toString() + 
					"<br>Lookat: " + pivot_pin.getPosition().toString() + 
					"<br>Position: "+ (e.position+1) +" of "+ hyperlapse.length() );
				camera_pin.setPosition(e.point.location);
			};

			pano.addEventListener( 'mousedown', function(e){
				e.preventDefault();

				is_moving = true;

				onPointerDownPointerX = e.clientX;
				onPointerDownPointerY = e.clientY;

				px = hyperlapse.position.x;
				py = hyperlapse.position.y;

			}, false );

			pano.addEventListener( 'mousemove', function(e){
				e.preventDefault();
				var f = hyperlapse.fov() / 500;

				if ( is_moving ) {
					var dx = ( onPointerDownPointerX - e.clientX ) * f;
					var dy = ( e.clientY - onPointerDownPointerY ) * f;
					hyperlapse.position.x = px + dx; // reversed dragging direction (thanks @mrdoob!)
					hyperlapse.position.y = py + dy;

					o.position_x = hyperlapse.position.x;
					o.position_y = hyperlapse.position.y;
				}

			}, false );

			pano.addEventListener( 'mouseup', function(){
				is_moving = false;

				hyperlapse.position.x = px;
				//hyperlapse.position.y = py;
			}, false );

			

			/* Dat GUI */

			//var gui = new dat.GUI();
			console.log(_elevation);
			var o = {
				distance_between_points:2, 
				max_points:dist, 
				fov: 120, 
				elevation:Math.floor(_elevation), 
				tilt:0, 
				millis:50, 
				offset_x:0,
				offset_y:0,
				offset_z:0,
				position_x:0,
				position_y:0,
				use_lookat:false,
				screen_width: window.innerWidth,
				screen_height: window.innerHeight,
				generate:function(){
					show( "Generating route..." );

					directions_renderer.setDirections({routes: []});

					var marker;
					while(_route_markers.length > 0) {
						marker = _route_markers.pop();
						marker.setMap(null);
					}

					request = {
						origin: start_point, 
						destination: end_point, 
						travelMode: google.maps.DirectionsTravelMode.DRIVING
					};

					directions_service.route(request, function(response, status) {
						if (status == google.maps.DirectionsStatus.OK) {   
							hyperlapse.generate({route: response});
						} else {
							console.log(status);
						}
					})
				},
				drop_pins:function(){
					var bounds = map.getBounds();
					var top_left = bounds.getNorthEast();
					var bot_right = bounds.getSouthWest();
					var hdif = Math.abs(top_left.lng() - bot_right.lng());
					var spacing = hdif/4;

					var center = map.getCenter();
					var c1 = new google.maps.LatLng(center.lat(), center.lng()-spacing);
					var c2 = new google.maps.LatLng(center.lat(), center.lng());
					var c3 = new google.maps.LatLng(center.lat(), center.lng()+spacing);

					hyperlapse.lookat = c2;
					pivot_pin.setPosition(c2);

					snapToRoad(c1, function(result1) {
						start_pin.setPosition(result1);
						start_point = result1;

						snapToRoad(c3, function(result3) {
							end_pin.setPosition(result3);
							end_point = result3;
							changeHash();
						});
					});
				}
			};


			/*var scn = gui.addFolder('screen');
			scn.add(o, 'screen_width', window.innerHeight).listen();
			scn.add(o, 'screen_height', window.innerHeight).listen();

			var parameters = gui.addFolder('parameters');

			var distance_between_points_control = parameters.add(o, 'distance_between_points', 5, 100);
			distance_between_points_control.onChange(function(value) {
				hyperlapse.setDistanceBetweenPoint(value);
			});

			var max_points = parameters.add(o, 'max_points', 10, 300);
			max_points.onChange(function(value) {
				hyperlapse.setMaxPoints(value);
			});

			var fov_control = parameters.add(o, 'fov', 1, 180);
			fov_control.onChange(function(value) {
				hyperlapse.setFOV(value);
			});

			var pitch_control = parameters.add(o, 'elevation', -1000, 1000);
			pitch_control.onChange(function(value) {
				_elevation = value;
				hyperlapse.elevation_offset = value;
				changeHash();
			});

			var millis_control = parameters.add(o, 'millis', 10, 250);
			millis_control.onChange(function(value) {
				hyperlapse.millis = value;
			});

			var offset_x_control = parameters.add(o, 'offset_x', -360, 360);
			offset_x_control.onChange(function(value) {
				hyperlapse.offset.x = value;
			});

			var offset_y_control = parameters.add(o, 'offset_y', -180, 180);
			offset_y_control.onChange(function(value) {
				hyperlapse.offset.y = value;
			});

			var offset_z_control = parameters.add(o, 'offset_z', -360, 360);
			offset_z_control.onChange(function(value) {
				hyperlapse.offset.z = value;
			});

			var position_x_control = parameters.add(o, 'position_x', -360, 360).listen();
			position_x_control.onChange(function(value) {
				hyperlapse.position.x = value;
			});

			var position_y_control = parameters.add(o, 'position_y', -180, 180).listen();
			position_y_control.onChange(function(value) {
				hyperlapse.position.y = value;
			});

			var tilt_control = parameters.add(o, 'tilt', -Math.PI, Math.PI);
			tilt_control.onChange(function(value) {
				hyperlapse.tilt = value;
			});

			var lookat_control = parameters.add(o, 'use_lookat')
			lookat_control.onChange(function(value) {
				hyperlapse.use_lookat = value;
			});

			parameters.open();
			*/

			//var play_controls = gui.addFolder('play controls');
			//play_controls.add(hyperlapse, 'play');
			//play_controls.add(hyperlapse, 'pause');
			//play_controls.add(hyperlapse, 'next');
			//play_controls.add(hyperlapse, 'prev');
			//play_controls.open();

			//gui.add(o, 'drop_pins');
			//gui.add(o, 'generate');
			//gui.add(hyperlapse, 'load');
			$("div.dg").remove();


			window.addEventListener('resize', function(){
				hyperlapse.setSize(window.innerWidth, window.innerHeight);
				o.screen_width = window.innerWidth;
				o.screen_height = window.innerHeight;
			}, false);

			var show_ui = false;
			document.addEventListener( 'keydown', onKeyDown, false );
			function onKeyDown ( event ) {

				switch( event.keyCode ) {
					case 72: /* H */
						show_ui = !show_ui;
						document.getElementById("controls").style.opacity = (show_ui)?1:0;
						break;

					case 190: /* > */
						hyperlapse.next();
						break;

					case 188: /* < */
						hyperlapse.prev();
						break;
				}

			};

			o.generate();
		}
		
		$(document).ready(function() {
		    $('#spinner').hide();
		   /* document.getElementById("searchButton").onclick = init;*/
		});
 		 
	</script> 
</head> 
<body> 
	<div id="pano" style="position: absolute; left: 0; top: 0; right: 0; bottom: 0; z-index:-1;"></div>
	<div id="controls">
	<div id="controls" >
	<div class="container">
        <div class="row">
            	<div class="col-md-6 ">
            	   <div id="map" style="width: 800px; height: 415px; float: right; padding: 0;"></div>
                </div>
                <div class="col-md-6 ">
        			<form id="map_form">
        			    
        				<!-- Remove this part -->
        			    <div class="form-group">
                    	      <input type="hidden" class="form-control" name="startpoint" id="startpoint" />
                		      <input type="hidden" name="start_cordinates" id="start_cordinates" /> 
                        </div>
                        <div class="form-group">
                        	 <input type="hidden" class="form-control" name="endpoint" id="endpoint" />
                			 <input type="hidden" name="end_cordinates" id="end_cordinates" />
                        </div>
                        <!-- _________________ --> 
                        
                        <div class="form-group">
                         	<label>Route_ID</label>
                			 <input type="text" class="form-control" value="Route_ID" name="routeid" id="routeid" />
                        </div>             
                        <div>             
                        <label>Direction</label>
                        <select id="ddldir">
						  <option value="a">a</option>
                          <option value="b" >b</option>
                          <option value="all" selected="selected">All</option>
                        </select>
                        <label>Camera angle</label>
                        <select id="ddlangle">
                          <option value="Forward">Forward</option>
                          <option value="Backward">Backward</option>
                          <option value="Left">Left</option>
                          <option value="Right">Right</option>
                          <option value="All" selected="selected">All</option>
                        </select>
                         <label> </label>
                    	<button type="button" id="searchButton" class="btn btn-success" onclick="getrouteinfo()">Generate</button>
        				</div>
                        
        			</form>
                </div>
            </div>
            </div>
		</div>

		<div id="text" style="width: 555px; height: 50px; float: left; padding-top: 10px; z-index:0; border-style:solid; border-width:medium;"></div>
        <div id="spinner" style="width: 555px; height: 50px; float: left; padding-top: 10px; z-index:0; border-style:solid; border-width:medium;">Generating video, please wait...</div>
	</div>
</body>
</html>
